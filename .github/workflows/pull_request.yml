name: Test on Pull Request
on:
  workflow_dispatch:
  pull_request:
    branches:
    - master

jobs:
  test:
    runs-on: ubuntu-18.04
    strategy:
      # tests can't run in parallel as they write and read data with same keys
      max-parallel: 1
      matrix:
        python-version: ['3.8', '3.9']
    steps:
    # Get the code into the container
    - name: Checkout Repository
      uses: actions/checkout@v3
    # Setup Python
    - uses: actions/setup-python@v4
      with:
        cache: pip
        cache-dependency-path: poetry.lock
        python-version: ${{ matrix.python-version }}
    - uses: abatilo/actions-poetry@v2
    - run: poetry install --no-interaction -E async
    # Test the code
    - name: Test code
      env:
        DETA_SDK_TEST_PROJECT_KEY: ${{secrets.DETA_SDK_TEST_PROJECT_KEY}}
        DETA_SDK_TEST_BASE_NAME: ${{secrets.DETA_SDK_TEST_BASE_NAME}}
        DETA_SDK_TEST_DRIVE_NAME: ${{secrets.DETA_SDK_TEST_DRIVE_NAME}}
        DETA_SDK_TEST_DRIVE_HOST: ${{secrets.DETA_SDK_TEST_DRIVE_HOST}}
        DETA_SDK_TEST_TTL_ATTRIBUTE: __expires
      run: |
        poetry run pytest tests/
